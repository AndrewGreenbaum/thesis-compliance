# Reusable workflow for checking thesis PDFs
# Users can call this from their own repos
#
# Example usage in user's repo:
#
# name: Check Thesis Formatting
# on: [push, pull_request]
# jobs:
#   check:
#     uses: AndrewGreenbaum/thesis-compliance/.github/workflows/thesis-check.yml@main
#     with:
#       pdf-path: thesis.pdf
#       spec: rackham

name: Thesis Compliance Check

on:
  workflow_call:
    inputs:
      pdf-path:
        description: 'Path to the thesis PDF file'
        required: true
        type: string
      spec:
        description: 'Style specification to check against (e.g., rackham, stanford, mit)'
        required: false
        type: string
        default: 'rackham'
      pages:
        description: 'Page range to check (e.g., "1-10,20")'
        required: false
        type: string
        default: ''
      strict:
        description: 'Fail on warnings as well as errors'
        required: false
        type: boolean
        default: false
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'

jobs:
  check-thesis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout user's repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install thesis-compliance
        run: |
          python -m pip install --upgrade pip
          pip install thesis-compliance

      - name: Check thesis formatting
        id: check
        run: |
          # Build arguments as array to prevent shell injection
          ARGS=("${{ inputs.pdf-path }}" --spec "${{ inputs.spec }}" --format json)

          if [ -n "${{ inputs.pages }}" ]; then
            ARGS+=(--pages "${{ inputs.pages }}")
          fi

          if [ "${{ inputs.strict }}" = "true" ]; then
            ARGS+=(--strict)
          fi

          echo "Running: thesis-check ${ARGS[*]}"
          thesis-check "${ARGS[@]}" > results.json || true

          # Parse results
          cat results.json

          # Check for errors with JSON error handling
          ERRORS=$(python -c "import json; data=json.load(open('results.json')); print(data.get('error_count', 0))" 2>/dev/null || echo "0")
          WARNINGS=$(python -c "import json; data=json.load(open('results.json')); print(data.get('warning_count', 0))" 2>/dev/null || echo "0")
          PASSED=$(python -c "import json; data=json.load(open('results.json')); print('true' if data.get('passed', False) else 'false')" 2>/dev/null || echo "false")

          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT

          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Thesis has $ERRORS formatting error(s)"
            exit 1
          fi

          if [ "${{ inputs.strict }}" = "true" ] && [ "$WARNINGS" -gt 0 ]; then
            echo "::warning::Thesis has $WARNINGS formatting warning(s)"
            exit 1
          fi

          echo "::notice::Thesis formatting check passed!"

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: thesis-compliance-report
          path: results.json
